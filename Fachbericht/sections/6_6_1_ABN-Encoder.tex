\subsubsection{ABN-Encoder}
\label{subsubsec:Inbetriebnahme_ABN-Encoder}

Der ABN-Encoder wird an den FOC-Treiber angeschlossen. Daher wird die Schnittstelle für den ABN-Encoder am FOC-Treiber initialisiert. Dazu werden die Parameter verwendet, welche in der TMCL-IDE verwendet wurden. Die zu schreibenden Parameter sind im Anhang Kapitel \ref{Appendix:ABN_Register} angehängt. Das Einlesen der PWM-Signale wird getestet, indem der Treiber in den Positionsmodus versetzt wird, wozu das Feedback des Rotors nötig ist. Hat die Initialisierung funktioniert, dreht sich der Motor an eine gewünschte Position und haltet dort. Zur Initialisierung gehören auch einige Einstellungen zu den PI-Reglern. Die Initialisierung sowie das Auslesen gewisser Register ist mit der Testapplikation ''\textit{4\underline{ }Motor\underline{ }ABN\underline{ }Encoder}'' möglich.

Die Regler, welche im FOC-Treiber integriert sind, werden verwendet, um einen Motor ein bestimmtes Drehmoment vorzugeben, ihn mit einer bestimmten Drehzahl drehen zu lassen und/oder ihn an eine bestimmte Position zu fahren. Im Gegensatz zu einem Motor, welchem nur eine Spannung vorgegeben wird, kann bei diesem Regelverfahren bei einer Abweichung des vorgegebenen Parameters nachgeregelt werden. So kann beispielsweise bei grösserer Belastung die angelegte Spannung erhöht werden, sodass die vorgegebene Geschwindigkeit gehalten werden kann.

Die Regelung eines Motors kann verschieden aufgebaut sein. Die Regelstruktur, wie sie im FOC-Treiber integriert ist, ist eine Kaskadenregelung. Eine Kaskadenregelung besteht in der Regel aus drei überlagerten Regelkreisen. Der innerste Regelkreis ist der Stromregelkreis. Dieser ist dem Geschwindigkeitsregelkreis unterlagert. Der Geschwindigkeitsregelkreis ist wiederum dem Positionsregelkreis unterlagert. Bei einer Kaskadenregelung ist die Ausgangsgrösse des überlagerten Regelkreises die Eingangsgrösse des unterlagerten Regelkreises. Aus Stabilitätsgründen ist darauf zu achten, dass die Nachstellzeit der äusseren Regelkreise grösser ist, als die der Inneren.


Die Regelung im FOC-Treiber besteht im innersten aus einem schnellen Stromregelkreis. Dieser soll in der Lage sein, schnellst möglich auf eine Abweichung des vorgegebenen Drehmoments zu reagieren. Die Abweichung des Stromregelkreises ist ein wichtiger Parameter zur Berechnung des Modulationsindex, welcher der Kommutierung des Motors dient.

Der Geschwindigkeitsregelkreis ist dem Stromregelkreis überlagert. Weicht die aktuelle Geschwindigkeit von der vorgegebenen Geschwindigkeit ab, so gibt der Geschwindigkeitsregelkreis dem Stromregelkreis eine Abweichung vor, wodurch der Strom durch die Spulen und somit das Drehmoment erhöht oder gesenkt wird.

Der Positionsregelkreis ist dem Geschwindigkeitskreis überlagert. Weicht die aktuelle Position von der vorgegebenen Position ab, so gibt der Positionsregelkreis dem Geschwindigkeitsregelkreis eine Abweichung vor, wodurch der Geschwindigkeitsregelkreis in die erforderliche Richtung korrigiert.

Mit der Begrenzung der Eingangsgrössen wird die Mechanik geschont und der Motor vor Überlast geschützt. Dies wird erreicht, indem die Ausgangsgrössen der PI-Regler mit einem Limit versehen werden. So kann der Strom durch die Spulen begrenzt werden, eine Maximalgeschwindigkeit definiert werden und die Enden der Positionen vorgegeben werden. Die Limits sind auf den Motor abgestimmt. \cite{stahl_simulation_2014}

Die Werte der PI-Regler wurden Experimentell bestimmt. Folgende Werte wurden dabei ermittelt:

\begin{tabularx}{\linewidth}{|l|X|X|l|}
\hline
\textbf{Regelkreis} & \textbf{P-Anteil} & \textbf{I-Anteil} & \textbf{Nachstellzeit}\\
\hline
Drehmoment & 100 & 1200 & \\
\hline
Fluss & 100 & 1200 & \\
\hline
Geschwindigkeit & 2000 & 300 & \\
\hline
Position & 100 & 0 & \\
\hline
\end{tabularx}

\todo{Nachstellzeit?}

Die Limits wurden folgendermassen gesetzt:

\begin{tabularx}{\linewidth}{|l|X||l|X|}
\hline
\textbf{Limit} & \textbf{Wert} & \textbf{Limit} & \textbf{Wert}\\
\hline
Drehmoment & 2500 & Fluss & 2500\\
\hline
Geschwindigkeit & 1500 &  & \\
\hline
\end{tabularx}

Die Regler wurden so bestimmt, dass die Regelkreise in unbelasteten Zustand ihre Sollwerte schnellst möglich erreichen, ohne überzuschiessen. Dies betrifft den Regler für den Stromregelkreis und den Regler für den Geschwindigkeitsregelkreis. Die zugehörigen Parameter wurden in der TMCL-IDE ermittelt. 

Das bisherige Setup hat sich nun um den ABN-Encoder erweitert und ist im Anhang Kapitel \ref{Appendix:ABN_Setup} ersichtlich.

Achtung, wenn die Scripts auf den Mikrocontroller des PartyMixers geladen werden ist darauf zu achten, dass die Achse des Motors frei beweglich ist und das Förderband nicht mit der Achse mitdreht, da ansonsten Schäden an der Maschine entstehen können. Es wird empfohlen die Scripts mit Mikrocontroller und EVAL-Boards zu testen.

Vorgehen:
\begin{enumerate}
\item Benötigte Applikation, welche im Software-Ordner auf dem USB-Stick oder Github \cite{aebi_projekt-6softwareatmega_2020} zu finden ist, in Atmel Studio öffnen.\\
\textcolor{magenta}{Software\textrightarrow Atmega\textrightarrow 4\underline{ }Motor\underline{ }ABN\underline{ }Encoder\textrightarrow 1\underline{ }Motor\underline{ }Testsoftware\textrightarrow Motor}\\

\item Software hochladen:\\
\textcolor{blue}{AtmelStudio\textrightarrow Tools\textrightarrow PartyMixer}\\

\item Ausgehende Signale des ABN-Encoders überprüfen. Im Anhang Kapitel \ref{Appendix:ABN_Signale} ist das Messbild des ABN-Encoder-Ausgangs zu sehen.

\end{enumerate}